#
# "Software pw3270, desenvolvido com base nos códigos fontes do WC3270  e X3270
# (Paul Mattes Paul.Mattes@usa.net), de emulação de terminal 3270 para acesso a
# aplicativos mainframe. Registro no INPI sob o nome G3270.
#
# Copyright (C) <2008> <Banco do Brasil S.A.>
#
# Este programa é software livre. Você pode redistribuí-lo e/ou modificá-lo sob
# os termos da GPL v.2 - Licença Pública Geral  GNU,  conforme  publicado  pela
# Free Software Foundation.
#
# Este programa é distribuído na expectativa de  ser  útil,  mas  SEM  QUALQUER
# GARANTIA; sem mesmo a garantia implícita de COMERCIALIZAÇÃO ou  de  ADEQUAÇÃO
# A QUALQUER PROPÓSITO EM PARTICULAR. Consulte a Licença Pública Geral GNU para
# obter mais detalhes.
#
# Você deve ter recebido uma cópia da Licença Pública Geral GNU junto com este
# programa;  se  não, escreva para a Free Software Foundation, Inc., 59 Temple
# Place, Suite 330, Boston, MA, 02111-1307, USA
#
# Contatos:
#
# perry.werneck@gmail.com	(Alexandre Perry de Souza Werneck)
# erico.mendonca@gmail.com	(Erico Mascarenhas de Mendonça)
# licinio@bb.com.br		(Licínio Luis Branco)
# kraucer@bb.com.br		(Kraucer Fernandes Mazuco)
# macmiranda@bb.com.br		(Marco Aurélio Caldas Miranda)
#

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
LIBDIR=@libdir@
PACKAGE=@PACKAGE@
PACKAGE_VERSION=@PACKAGE_VERSION@
datarootdir=@datarootdir@
LOCALEDIR=@localedir@
PLUGINS=@SELECTED_PLUGINS@

TARGETS = $(PACKAGE)@EXEEXT@

# Set command paths and mkfb (which has to run locally)
MKFB = mkfb
CC = @CC@
LD = @LD@
NATIVECC = @HOST_CC@
WINDRES = @WINDRES@

####################################################################################################
# Set compile/link parameters
####################################################################################################

CFLAGS = @OS_CFLAGS@ -g -Wall -O -Dpw3270 -DLIBDIR=\"$(LIBDIR)\" -DDATAROOTDIR=\"$(datarootdir)\" -DLOCALEDIR=\"$(LOCALEDIR)\" -Isrc/include
API_CFLAGS=@LIBSSL_CFLAGS@ @API_CFLAGS@

APP_CFLAGS=@GTK_CFLAGS@ @LIBGNOME_CFLAGS@ @APP_CFLAGS@
APP_LDFLAGS=@GTK_LIBS@ @LIBGNOME_LIBS@ @OS_LFLAGS@


####################################################################################################
# Sources
####################################################################################################

APP_SRCS =	main.c iocallback.c topwindow.c terminal.c screen.c actions.c mouse.c \
		clipboard.c print.c config.c colors.c keypad.c plugin.c filetransfer.c \
		version.c @OS_APPSRCS@

API_SRCS = 	XtGlue.c actions.c ansi.c apl.c charset.c ctlr.c \
		ft.c ft_cut.c ft_dft.c glue.c host.c icmd.c idle.c kybd.c \
		macros.c print.c printer.c proxy.c resources.c rpq.c screen.c see.c \
		sf.c tables.c telnet.c toggles.c trace_ds.c utf8.c util.c \
		xio.c keymap.c resolver.c log.c @OS_APISRCS@

####################################################################################################
# Targets
####################################################################################################

Release:	$(foreach BIN, $(TARGETS), bin/Release/$(BIN)) \
		src/gui/$(PACKAGE).@LOGOEXT@ \
		src/gui/$(PACKAGE).ico \
		$(foreach BIN, $(PLUGINS), bin/Release/plugins/$(BIN)@DLLEXT@)
	@install --mode=644 src/gui/$(PACKAGE).@LOGOEXT@ bin/Release/$(PACKAGE).@LOGOEXT@
	@cp src/gui/$(PACKAGE).ico bin/Release/$(PACKAGE).ico
	@msgfmt -c -v -o bin/Release/pt_BR.mo po/pt_BR.po
	@rm -f bin/Release/gtk-runtime
	@ln -s "@GTKRUNTIME@" bin/Release/gtk-runtime
	@echo @PACKAGE@ Ok!

Debug: $(foreach BIN, $(TARGETS), bin/Debug/$(BIN)) $(foreach BIN, $(PLUGINS), bin/Debug/plugins/$(BIN)@DLLEXT@) src/gui/$(PACKAGE).@LOGOEXT@

run: bin/Debug/@PROGRAM_NAME@@EXEEXT@ $(foreach BIN, $(PLUGINS), bin/Debug/plugins/$(BIN)@DLLEXT@) src/gui/$(PACKAGE).@LOGOEXT@
	@msgfmt -c -v -o $(LOCALEDIR)/pt_BR/LC_MESSAGES/@PROGRAM_NAME@.mo po/pt_BR.po
	@cd bin/Debug ; LD_LIBRARY_PATH=. ./@PROGRAM_NAME@ --program-data="../../"

rpm: @PACKAGE@-@PACKAGE_VERSION@.tar.gz
	mkdir -p `rpm --eval="%{u2p:%{_sourcedir}}"`
	cp @PACKAGE@-@PACKAGE_VERSION@.tar.gz `rpm --eval="%{u2p:%{_sourcedir}}"`
	rpmbuild -ba pw3270.spec


####################################################################################################
# Rules
####################################################################################################

GLOBAL_DEPENDS=src/include/*.h src/include/lib3270/*.h Makefile

####################################################################################################
# Debug Rules
####################################################################################################

obj/Debug/src/lib/%.o: src/lib/%.c src/lib/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 $(API_CFLAGS) $(CFLAGS) -ggdb -o $@ -c $<

obj/Debug/src/gui/%.o: src/gui/%.c src/gui/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 $(CFLAGS) $(APP_CFLAGS) -ggdb -o $@ -c $<

obj/Debug/src/gui/resources.o: src/gui/resources.rc src/gui/$(PACKAGE).ico Makefile
	@echo $< ...
	@$(WINDRES) --include-dir=src/gui -i $< -o $@

obj/Debug/version.o: src/version.c
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 $(CFLAGS) -Isrc/lib -ggdb -o $@ -c $<

####################################################################################################
# Release Rules
####################################################################################################

obj/Release/src/lib/%.o: src/lib/%.c src/lib/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -Werror $(API_CFLAGS) $(CFLAGS) -o $@ -c $<

obj/Release/src/gui/%.o: src/gui/%.c src/gui/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) $(CFLAGS) $(APP_CFLAGS) -o $@ -c $<

obj/Release/src/gui/resources.o: src/gui/resources.rc src/gui/$(PACKAGE).ico Makefile
	@echo $< ...
	@$(WINDRES) --include-dir=src/gui -i $< -o $@

obj/Release/version.o: src/version.c
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) $(CFLAGS) -Werror -Isrc/lib -o $@ -c $<

####################################################################################################
# Release Targets
####################################################################################################

bin/Release/@PROGRAM_NAME@@EXEEXT@: bin/Release/lib3270@DLLEXT@ $(foreach SRC, $(basename $(APP_SRCS)), obj/Release/src/gui/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) @OS_EXECOPT@ @LD_RLSFLAGS@ -o $@ $^ $(APP_LDFLAGS)

bin/Release/lib3270@DLLEXT@: obj/Release/version.o obj/Release/src/lib/fallbacks.o $(foreach SRC, $(basename $(API_SRCS)), obj/Release/src/lib/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@rm -f $(basename \$(@F)).a
	@rm -f $(basename \$(@F)).def
	@$(LD) @OS_DLLFLAGS@ @LD_APIFLAGS@ @LD_RLSFLAGS@ -o $@ $^ @LIBSSL_LIBS@ @OS_LFLAGS@

####################################################################################################
# Debug Targets
####################################################################################################

bin/Debug/@PROGRAM_NAME@@EXEEXT@: bin/Debug/lib3270@DLLEXT@ $(foreach SRC, $(basename $(APP_SRCS)), obj/Debug/src/gui/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) @OS_EXECOPT@ -o $@ $^ -Lbin/Debug -l3270 $(APP_LDFLAGS)

bin/Debug/lib3270@DLLEXT@: obj/Debug/version.o obj/Release/src/lib/fallbacks.o $(foreach SRC, $(basename $(API_SRCS)), obj/Debug/src/lib/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@rm -f $(basename \$(@F)).a
	@rm -f $(basename \$(@F)).def
	@$(LD) @OS_DLLFLAGS@ -o $@ $^ @LIBSSL_LIBS@ @OS_LFLAGS@

####################################################################################################
# Plugins
####################################################################################################

bin/Release/plugins/rx3270@DLLEXT@: src/plugins/rexx/*.c src/plugins/rexx/Makefile
	make -C src/plugins/rexx ../../../$@

bin/Debug/plugins/rx3270@DLLEXT@: src/plugins/rexx/*.c src/plugins/rexx/Makefile
	make -C src/plugins/rexx ../../../$@

####################################################################################################
# Misc Targets
####################################################################################################

src/gui/$(PACKAGE).ico: @ICONFILE@
	@cp @ICONFILE@ $@

src/gui/$(PACKAGE).@LOGOEXT@: @LOGOFILE@
	@convert @LOGOFILE@ $@

src/lib/fallbacks.c:  src/lib/X3270.xad
	@make -C src/lib fallbacks.c

src/version.c:	src/lib/*.c src/mkversion.sh Makefile $(GLOBAL_DEPENDS)
	@src/mkversion.sh

sources.lst: Makefile src/gui/*.c src/plugins/rexx/*.c Makefile
	@rm -f $@
	@for i in src/gui/*.c; do echo $$i >> $@; done
	@for i in src/plugins/rexx/*.c; do echo $$i >> $@; done

$(PACKAGE).pot: sources.lst
	@xgettext	--files-from=sources.lst \
			--default-domain=$(PACKAGE) --language=C \
			--keyword=_ --keyword=N_ --sort-output --output=- \
	| sed "s&PACKAGE VERSION&$(PACKAGE) $(PACKAGE_VERSION)&;s&CHARSET&UTF-8&" > $@

$(PACKAGE).po: $(PACKAGE).pot
	@msginit --no-translator -o $(PACKAGE).po -i $(PACKAGE).pot

tgz: $(PACKAGE)-$(PACKAGE_VERSION).tar.gz

install: Release po/pt_BR.po
	@mkdir -p $(DESTDIR)/$(bindir)
	@mkdir -p $(DESTDIR)/$(LIBDIR)/$(PACKAGE)/plugins
	@mkdir -p $(DESTDIR)/$(datarootdir)/$(PACKAGE)/ui
	@mkdir -p $(DESTDIR)/$(LOCALEDIR)
	@mkdir -p $(DESTDIR)/@includedir@/lib3270
	@for i in $(TARGETS); do install --mode=755 bin/Release/$$i $(DESTDIR)/$(bindir); done
	@for i in $(PLUGINS); do install --mode=755 bin/Release/plugins/$$i@DLLEXT@ $(DESTDIR)/$(LIBDIR)/$(PACKAGE)/plugins; done
	@install --mode=755 bin/Release/lib3270.so $(DESTDIR)/$(LIBDIR)
	@install --mode=644 ui/default.xml $(DESTDIR)/$(datarootdir)/$(PACKAGE)/ui
	@install --mode=644 ui/default.act $(DESTDIR)/$(datarootdir)/$(PACKAGE)/ui
	@install --mode=644 src/gui/$(PACKAGE).@LOGOEXT@ $(DESTDIR)/$(datarootdir)/$(PACKAGE)
	@install --mode=644 src/gui/colors.conf $(DESTDIR)/$(datarootdir)/$(PACKAGE)
	@install --mode=644 src/include/lib3270/*.h $(DESTDIR)/@includedir@/lib3270

	@mkdir -p $(DESTDIR)/$(LOCALEDIR)/pt_BR/LC_MESSAGES
	@msgfmt -c -v -o $(DESTDIR)/$(LOCALEDIR)/pt_BR/LC_MESSAGES/pw3270.mo po/pt_BR.po

$(PACKAGE)-$(PACKAGE_VERSION).tar.gz: clean

	@rm -fr $(TMPDIR)/$(PACKAGE).tmp

	@mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp pw3270.cbp $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp aclocal.m4 $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp AUTHORS $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp configure.ac $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp *.in $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)

	mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/image
	cp -r image/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/image

	mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/ui
	cp -r ui/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/ui

	@mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/po
	@cp -r po/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/po

	@mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/src
	@cp -r src/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/src

	@mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/scripts
	@cp -r scripts/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/scripts

	@rm -f $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/Makefile
	@rm -f $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/*.layout
	@tar --create --gzip --verbose --directory $(TMPDIR)/$(PACKAGE).tmp --exclude=.svn --file=$@ $(PACKAGE)-$(PACKAGE_VERSION)
	@echo $@

clean:
	@rm -fr obj
	@rm -fr bin
	@rm -f	src/lib/fallbacks.c
	@rm -f	src/lib/version.o
	@rm -f	src/lib/mkfb.exe
	@rm -f	src/version.c
	@rm -f	sources.lst
	@rm -f	$(PACKAGE)-$(PACKAGE_VERSION).tar.gz
	@rm -f $(PACKAGE).pot
	@rm -f $(PACKAGE).po
	@rm -fr autom4te.cache
	@rm -f config.status
	@rm -f *.lnk
	@rm -fr locale
	@rm -f *.nsi
	@rm -f src/gui/$(PACKAGE).ico
	@rm -f src/gui/$(PACKAGE).@LOGOEXT@

	@if [ -e src/plugins/rexx/Makefile ]; then make -C src/plugins/rexx clean; fi
	@if [ -e src/extensions/uno/Makefile ]; then make -C src/extensions/uno clean; fi

	@find . -name "*.def" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.a" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.save" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*~" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.bak" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.log" -exec mv -f {} $(TMPDIR) \;
	@find . -name "leak.out" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.tmp" -exec mv -f {} $(TMPDIR) \;
