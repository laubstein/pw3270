

#---[ Compiler ]---------------------------------------------------------------------------------------------------

CXX=@CXX@
CXXFLAGS=@CXXFLAGS@
LDFLAGS=@LDFLAGS@

#---[ G3270 ]------------------------------------------------------------------------------------------------------

G3270_CFLAGS ?= @G3270_CFLAGS@
G3270_LFLAGS ?= @G3270_LIBS@

#---[ Component Data ]---------------------------------------------------------------------------------------------

COMP_NAME ?= Ooo3270
INTF_NAME ?= I3270
OWNER_PATH ?= br/com/bb
COMP_IMPL_NAME ?= $(COMP_NAME).uno@DLLEXT@
COMP_RDB_NAME ?= $(COMP_NAME).uno.rdb

CXX_FILES = main.cxx connection.cxx screen.cxx actions.cxx

#---[ Settings ]---------------------------------------------------------------------------------------------------

CPPU_ENV ?= @CPPUENV@

#---[ OpenOffice environment variables ]---------------------------------------------------------------------------

OO_SDK_HOME ?= @OO_SDK_HOME@
OFFICE_HOME ?= @OFFICE_HOME@
OO_PROGRAM_DIR ?= $(OFFICE_HOME)/basis3.0/program
OFFICE_PROGRAM ?= @OFFICE_PROGRAM@

# OO_INCLUDE_PATH ?= $(OO_SDK_HOME)/inc
OO_INCLUDE_PATH ?= @OO_INCLUDE_PATH@
OO_CXX_INCLUDE_PATH ?= @OO_INCLUDE_PATH@/offuh

OO_CXXFLAGS ?= -DCPPU_ENV=$(CPPU_ENV) @OS_CFLAGS@ -DLANGUAGE_BINDING_NAME=\"$(CPPU_ENV)\" -I$(OO_INCLUDE_PATH) -I$(OO_CXX_INCLUDE_PATH) -Isrc/inc
OO_LDFLAGS ?= -L@OO_URE_LIB@ -L$(OO_SDK_HOME)/lib -Wl,-rpath-link=@OO_URE_LIB@ @OO_LIBS@


# -luno_cppu
# LINK_LIBS=-L$(OUT)/lib -L$(PRJ)/$(PLATFORM)/lib -L"$(OFFICE_PROGRAM_PATH)"

#SALLIB=-luno_sal
#CPPULIB=-luno_cppu
#CPPUHELPERLIB=-luno_cppuhelper$(COMID)
#SALHELPERLIB=-luno_salhelper$(COMID)
#REGLIB=-lreg
#STORELIB=-lstore
#STLPORTLIB=-lstlport_gcc


#OO_SDK_CPP_HOME ?= /usr/bin
#OO_SDK_MAKE_HOME ?= /usr/bin
#OO_SDK_OUT ?= /home/perry/openoffice.org3.0_sdk
#OO_SDK_URE_BIN_DIR ?= /usr/lib/ooo3/program
#OO_SDK_URE_JAVA_DIR ?= /opt/openoffice.org/basis3.0/program/classes
#OO_SDK_URE_LIB_DIR ?= / opt/openoffice.org/basis3.0/program
#OO_SDK_ZIP_HOME ?= /usr/bin

#---[ OpenOffice Tools ]-------------------------------------------------------------------------------------------

IDLC ?= @IDLC@
CPPUMAKER ?= @CPPUMAKER@
REGMERGE ?= @REGMERGE@
REGCOMP ?= @REGCOMP@

#---[ Debug Rules ]------------------------------------------------------------------------------------------------

Debug: bin/Debug/$(COMP_NAME)@EXEEXT@

install-debug: bin/Debug/$(COMP_IMPL_NAME) src/$(COMP_NAME).uno.rdb
	@cp -f bin/Debug/$(COMP_IMPL_NAME) $(DESTDIR)/$(OO_PROGRAM_DIR)
	@cp -f src/$(COMP_NAME).uno.rdb $(DESTDIR)/$(OO_PROGRAM_DIR)/$(COMP_NAME).uno.rdb
	@$(REGCOMP) -register -r $(DESTDIR)/$(OO_PROGRAM_DIR)/$(COMP_NAME).uno.rdb -c $(DESTDIR)/$(OO_PROGRAM_DIR)/$(COMP_IMPL_NAME)
	@echo "bin/Debug/$(COMP_IMPL_NAME) src/$(COMP_NAME).uno.rdb -> $(OO_PROGRAM_DIR)"

bin/Debug/$(COMP_NAME)@EXEEXT@: obj/Debug/src/test_program.o bin/Debug/$(COMP_IMPL_NAME)
	@echo $@ ...
	@mkdir -p `dirname $@`
	$(CXX) $(OO_LDFLAGS) -L$(OO_SDK_HOME)/lib -luno_cppuhelpergcc3 -L./bin/Debug bin/Debug/$(COMP_IMPL_NAME) -o $@ obj/Debug/src/test_program.o

obj/Debug/src/%.o: src/%.cxx src/*.hpp src/inc/$(OWNER_PATH)/$(INTF_NAME).hpp
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CXX) -DDEBUG=1 $(CXXFLAGS) $(OO_CXXFLAGS) $(G3270_CFLAGS) -ggdb -o $@ -c $<

bin/Debug/$(COMP_IMPL_NAME): $(foreach OBJ, $(CXX_FILES), obj/Debug/src/$(basename $(OBJ)).o)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CXX)  $(G3270_LFLAGS) @OS_DLLFLAGS@ -o $@ $^ $(OO_LDFLAGS)

run: bin/Debug/$(COMP_NAME)@EXEEXT@
	@LD_LIBRARY_PATH=$(OO_SDK_HOME)/ure/lib:$(OFFICE_HOME)/ure/lib:bin/Debug bin/Debug/$(COMP_NAME)

test: install-debug
	$(OFFICE_PROGRAM)

#---[ Release Rules ]----------------------------------------------------------------------------------------------

Release: @PACKAGE@.oxt

obj/Release/src/%.o: src/%.cxx src/*.hpp src/inc/$(OWNER_PATH)/$(INTF_NAME).hpp
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CXX) -DNDEBUG=1 $(CXXFLAGS) $(OO_CXXFLAGS) $(G3270_CFLAGS) -o $@ -c $<

bin/Release/$(COMP_IMPL_NAME): $(foreach OBJ, $(CXX_FILES), obj/Release/src/$(basename $(OBJ)).o)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CXX) $(OO_LDFLAGS) $(G3270_LFLAGS) @OS_DLLFLAGS@ -o $@ $^

%.oxt: bin/Release/$(COMP_IMPL_NAME) src/$(COMP_NAME).uno.rdb description.xml manifest.xml
	@echo $@
	@rm -fr build.tmp
	@mkdir -p build.tmp/META-INF
	@cp manifest.xml build.tmp/META-INF
	@cp description.xml build.tmp
	@cp description.txt build.tmp
	@cp uno3270.png build.tmp
	@cp bin/Release/$(COMP_IMPL_NAME) build.tmp
	@cp src/$(COMP_NAME).uno.rdb build.tmp
	@cd build.tmp ; zip -m -r ../$@ .

#---[ Uno Rules ]--------------------------------------------------------------------------------------------------

src/$(COMP_NAME).uno.rdb : src/$(COMP_NAME).urd
	@echo $< ...
	@rm -f $@
	@$(REGMERGE) $@ / @TYPES_RDB@
	@$(REGMERGE) $@ /UCR $<
	@$(REGMERGE) $@ / $<

src/$(COMP_NAME).urd: src/$(COMP_NAME).idl Makefile
	@echo $< ...
	@$(IDLC) -C -I. -I$(OO_SDK_HOME)/idl -Osrc $<

src/inc/$(OWNER_PATH)/$(INTF_NAME).hpp: src/$(COMP_NAME).uno.rdb
	@rm -fr src/inc
	@mkdir -p src/inc
	@cd src/inc ; $(CPPUMAKER) -Gc -L -BUCR ../$(COMP_NAME).uno.rdb

#---[ Misc Rules ]-------------------------------------------------------------------------------------------------

%.zip: clean
	@rm -f $@
	@zip -9 -r $@ .

tgz: @PACKAGE@-@PACKAGE_VERSION@.tar.gz

@PACKAGE@-@PACKAGE_VERSION@.tar.gz: clean
	@echo $@ ...
	@find . -name "stamp-h1" -exec mv -f {} $(TMPDIR) \;
	@rm -fr $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@

	@mkdir -p $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@
	@cp aclocal.m4 $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@
	@cp AUTHORS $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@
	@cp configure.ac $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@
	@cp *.in $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@
	@cp description.txt $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@
	@cp uno3270.png $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@

	@mkdir -p $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@/src
	@cp -R src/* $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@/src

	@mkdir -p $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@/scripts
	@cp -R scripts/* $(TMPDIR)/@PACKAGE@-@PACKAGE_VERSION@/scripts

	@rm -f @PACKAGE@-@PACKAGE_VERSION@.tar.gz
	@tar --create --gzip --verbose --directory=$(TMPDIR) --exclude=.svn --file=@PACKAGE@-@PACKAGE_VERSION@.tar.gz @PACKAGE@-@PACKAGE_VERSION@

rpm: @PACKAGE@-@PACKAGE_VERSION@.tar.gz
	mkdir -p `rpm --eval="%{u2p:%{_sourcedir}}"`
	cp @PACKAGE@-@PACKAGE_VERSION@.tar.gz `rpm --eval="%{u2p:%{_sourcedir}}"`
	rpmbuild -ba OpenOffice-3270.spec

#---[ Targets ]----------------------------------------------------------------------------------------------------

clean:
	@rm -fr obj
	@rm -fr bin
	@rm -fr src/inc
	@rm -fr build.tmp
	@rm -f @PACKAGE@-@PACKAGE_VERSION@.tar.gz
	@rm -fr build.tmp
	@find . -name "*.save" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*~" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.bak" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.log" -exec mv -f {} $(TMPDIR) \;
	@find . -name "leak.out" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.urd" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.rdb" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.tmp" -exec mv -f {} $(TMPDIR) \;


