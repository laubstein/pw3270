# Copyright 2008 by Perry Werneck.
#  Permission to use, copy, modify, and distribute this software and its
#  documentation for any purpose and without fee is hereby granted,
#  provided that the above copyright notice appear in all copies and that
#  both that copyright notice and this permission notice appear in
#  supporting documentation.
#
# g3270 is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the file LICENSE for more details.

PKGMODULES=gtk+-2.0 gdk-2.0 glib-2.0 gthread-2.0 libgnomeui-2.0
include src/sources.mak

CC = @CC@
LD = @CC@
CFLAGS = @CFLAGS@ `@PKGCONFIG@ --cflags $(PKGMODULES)` -DBUILD=\"`date +%G%m%d%H%M`\" -Isrc -Wall
LFLAGS = `@PKGCONFIG@ --libs $(PKGMODULES)` -l3270

DEBUG_OBJECTS=$(foreach SRC, $(basename $(SOURCES)), obj/Debug/src/$(SRC).o)
RELEASE_OBJECTS=$(foreach SRC, $(basename $(SOURCES)), obj/Release/src/$(SRC).o)
PREREQS=Makefile src/*.h

#---[ Rules ]---------------------------------------------------------------------

obj/Debug/src/%.o: src/%.c $(PREREQS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 -DG3270_CORE -DG_ERRORCHECK_MUTEXES $(CFLAGS) -ggdb -o $@ -c $<

obj/Release/src/%.o: src/%.c $(PREREQS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -Lbin/Release -DG3270_CORE  -DNDEBUG=1 $(CFLAGS) -Werror -o $@ -c $<

bin/Debug/@PACKAGE_NAME@:	bin/Debug/lib3270.so $(DEBUG_OBJECTS)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(LD) -Lbin/Debug -o $@ $^ $(LFLAGS)
	@echo $@ Ok!

bin/Release/@PACKAGE_NAME@:	bin/Release/lib3270.so $(RELEASE_OBJECTS)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(LD) -Lbin/Release -o $@ $^ $(LFLAGS)
	@echo $@ Ok!


#---[ Targets ]-------------------------------------------------------------------

Debug: bin/Debug/@PACKAGE_NAME@

Release: bin/Release/@PACKAGE_NAME@

zip: @PACKAGE_TARNAME@.zip

run: bin/Debug/@PACKAGE_NAME@
	@LD_LIBRARY_PATH=bin/Debug ./bin/Debug/@PACKAGE_NAME@

bin/Debug/lib3270.so: src/lib/Makefile src/lib/*.c src/lib/*.h
	@mkdir -p `dirname $@`
	@make -C src/lib lib3270.so
	@mv src/lib/lib3270.so $@

bin/Release/lib3270.so: src/lib/Makefile src/lib/*.c src/lib/*.h
	@mkdir -p `dirname $@`
	@make -C src/lib lib3270.so
	@mv src/lib/lib3270.so $@

clean:
	@rm -f  $(DEBUG_OBJECTS)
	@rm -f	$(RELEASE_OBJECTS)
	@rm -f	@PACKAGE_TARNAME@.tar.gz
	@rm -fr obj
	@rm -fr bin
	@rm -fr autom4te.cache
	@rm -f config.status
	@find . -name "*.save" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*~" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.bak" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.log" -exec mv -f {} $(TMPDIR) \;
	@find . -name "leak.out" -exec mv -f {} $(TMPDIR) \;

tgz: @PACKAGE_TARNAME@.tar.gz

@PACKAGE_TARNAME@.tar.gz: clean
	@rm -f $@
	@tar --create --gzip --verbose --directory .. --file=$@ `basename $(PWD)`



