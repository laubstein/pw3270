#
# Copyright 2008, Banco do Brasil S.A.
#
# This file is part of g3270
#
# This program file is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; version 3 of the License.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
# for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program in a file named COPYING; if not, write to the
# Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor,
# Boston, MA 02110-1301 USA
#
# Authors:
#
# Perry Werneck<perry.werneck@gmail.com>
#

PACKAGE=@PACKAGE@
PACKAGE_VERSION=@PACKAGE_VERSION@

# OS Stuff
CROSS=1
TARGETS = $(PACKAGE)@BINEXT@ @EXTRA_TARGETS@

# Set command paths and mkfb (which has to run locally)
MKFB = mkfb
CC = @CC@
NATIVECC = @NATIVECC@
WINDRES = @WINDRES@

# Set compile/link parameters
CFLAGS = $(EXTRA_FLAGS) -mno-cygwin -g -Wall @XCPPFLAGS@ -O -DG3270 -Isrc/include
DLLFLAGS = $(EXTRA_FLAGS) -mno-cygwin -shared -Wl,--export-all-symbols -Wl,--enable-auto-import

# Sources
G3270_SRCS =	g3270.c iocallback.c topwindow.c terminal.c screen.c actions.c mouse.c \
				clipboard.c print.c config.c colors.c keypad.c plugin.c @EXTRASRC@

LIBRARY_SRCS =	XtGlue.c actions.c ansi.c apl.c charset.c ctlr.c \
				ft.c ft_cut.c ft_dft.c glue.c help.c host.c icmd.c idle.c kybd.c \
				macros.c print.c printer.c proxy.c resources.c rpq.c screen.c see.c \
				sf.c tables.c telnet.c toggles.c trace_ds.c utf8.c util.c \
				xio.c keymap.c w3misc.c winvers.c windirs.c resolver.c log.c

# Main Targets
Debug: $(foreach BIN, $(TARGETS), bin/Debug/$(BIN))

Release: $(foreach BIN, $(TARGETS), bin/Release/$(BIN))

# Rules
GLOBAL_DEPENDS=src/include/*.h src/include/lib3270/*.h Makefile

# Debug Rules
obj/Debug/src/lib/%.o: src/lib/%.c src/lib/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 -DLIB3270=1 $(CFLAGS) @SSL_CFLAGS@ -Isrc/lib -Isrc/include/lib3270 -ggdb -o $@ -c $<

obj/Debug/src/g3270/%.o: src/g3270/%.c src/g3270/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 $(CFLAGS) @GTK_CFLAGS@ -Isrc/lib -ggdb -o $@ -c $<

obj/Debug/src/g3270/resources.o: src/g3270/resources.rc src/g3270/g3270.ico Makefile
	@echo $< ...
	@$(WINDRES) --include-dir=src/g3270 -i $< -o $@

obj/Debug/version.o: src/version.c
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 $(CFLAGS) -Isrc/lib -ggdb -o $@ -c $<

# Release rules
obj/Release/src/lib/%.o: src/lib/%.c src/lib/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DLIB3270=1 $(CFLAGS) -Werror @SSL_CFLAGS@ -Isrc/lib -Isrc/include/lib3270 -ggdb -o $@ -c $<

obj/Release/src/g3270/%.o: src/g3270/%.c src/g3270/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) $(CFLAGS) -Werror @GTK_CFLAGS@ -Isrc/lib -o $@ -c $<

obj/Release/src/g3270/resources.o: src/g3270/resources.rc src/g3270/g3270.ico Makefile
	@echo $< ...
	@$(WINDRES) --include-dir=src/g3270 -i $< -o $@

obj/Release/version.o: src/version.c
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) $(CFLAGS) -Werror -Isrc/lib -o $@ -c $<

obj/Release/src/lib/w3n46.o: src/lib/resolver.c
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) $(CFLAGS) -Werror -Isrc/lib -DW3N46 -c -o $@ $^

# Release Targets
bin/Release/g3270@BINEXT@: bin/Release/lib3270.@DLLEXT@ $(foreach SRC, $(basename $(G3270_SRCS)), obj/Release/src/g3270/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) @EXEOPT@ -o $@ $^ @GTK_LIBS@ @OS_LIBS@

bin/Release/lib3270.@DLLEXT@: obj/Release/version.o obj/Release/src/lib/fallbacks.o $(foreach SRC, $(basename $(LIBRARY_SRCS)), obj/Release/src/lib/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) $(DLLFLAGS) -o $@ $^ @SSL_LIBS@ @OS_LIBS@

bin/Release/w3n46.dll: obj/Release/src/lib/w3n46.o
	@$(CC) $(DLLFLAGS) -o $@ $^ @OS_LIBS@

# Debug Targets
bin/Debug/g3270@BINEXT@: bin/Debug/lib3270.@DLLEXT@ $(foreach SRC, $(basename $(G3270_SRCS)), obj/Debug/src/g3270/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) @EXEOPT@ -o $@ $^ @GTK_LIBS@ @OS_LIBS@

bin/Debug/lib3270.@DLLEXT@: obj/Debug/version.o obj/Release/src/lib/fallbacks.o $(foreach SRC, $(basename $(LIBRARY_SRCS)), obj/Debug/src/lib/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) $(DLLFLAGS) -o $@ $^ @SSL_LIBS@ @OS_LIBS@

bin/Debug/w3n46.dll: obj/Release/src/lib/w3n46.o
	@$(CC) $(DLLFLAGS) -o $@ $^ @OS_LIBS@

# Other targets
src/lib/fallbacks.c:  src/lib/X3270.xad
	@make -C src/lib fallbacks.c

src/version.c:	src/lib/*.c src/mkversion.sh Makefile $(GLOBAL_DEPENDS)
	@src/mkversion.sh

sources.lst: Makefile
	@rm -f $@
	@for i in $(G3270_SRCS); do echo $$i >> $@; done

$(PACKAGE).pot: sources.lst $(foreach SRC, $(G3270_SRCS), src/g3270/$(SRC))
	@xgettext	--files-from=sources.lst --directory=src/g3270 \
				--default-domain=$(PACKAGE) --language=C \
				--keyword=_ --keyword=N_ --sort-output --output=- \
	| sed "s&PACKAGE VERSION&$(PACKAGE) $(PACKAGE_VERSION)&;s&CHARSET&UTF-8&" > $@

$(PACKAGE).po: $(PACKAGE).pot
	@msginit --no-translator -o $(PACKAGE).po -i $(PACKAGE).pot

clean:
	@rm -fr obj
	@rm -fr bin
	@rm -f	src/lib/fallbacks.c
	@rm -f	src/lib/version.o
	@rm -f	src/lib/mkfb.exe
	@rm -f	src/version.c
	@rm -f	sources.lst
	@rm -f	g3270.tar.gz
	@rm -f $(PACKAGE).pot
	@rm -f $(PACKAGE).po
	@rm -fr autom4te.cache
	@rm -f config.status
	@rm -f *.lnk
	@rm -fr locale
	@rm -f *.nsi
	@find . -name "*.save" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*~" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.bak" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.log" -exec mv -f {} $(TMPDIR) \;
	@find . -name "leak.out" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.tmp" -exec mv -f {} $(TMPDIR) \;
