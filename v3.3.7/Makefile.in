#
# Copyright 2008, Banco do Brasil S.A.
#
# This file is part of g3270
#
# This program file is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; version 3 of the License.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
# for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program in a file named COPYING; if not, write to the
# Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor,
# Boston, MA 02110-1301 USA
#
# Authors:
#
# Perry Werneck<perry.werneck@gmail.com>
#

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
LIBDIR=@libdir@
PACKAGE=@PACKAGE@
PACKAGE_VERSION=@PACKAGE_VERSION@
datarootdir=@datarootdir@
LOCALEDIR=@localedir@
PLUGINS=@SELECTED_PLUGINS@

# OS Stuff
@CROSS@
windows-exeopt = -mwindows

windows-targets = w3n46.dll
TARGETS = $(PACKAGE)@BINEXT@ $(@host_os@-targets)

# Set command paths and mkfb (which has to run locally)
MKFB = mkfb
CC = @CC@

ifdef CROSS
	NATIVECC = @NATIVECC@
	WINDRES = @WINDRES@
else
	NATIVECC = $(CC)
endif

# Set compile/link parameters
windows-dllflags=-Wl,--export-all-symbols -Wl,--enable-auto-import
CFLAGS = @EXTRA_FLAGS@ -g -Wall @XCPPFLAGS@ -O -DG3270 -DLIBDIR=\"$(LIBDIR)\" -DDATAROOTDIR=\"$(datarootdir)\" -DLOCALEDIR=\"$(LOCALEDIR)\" -Isrc/include
DLLFLAGS = @EXTRA_FLAGS@ -shared $(@host_os@-dllflags)

# Sources
windows-srcs = 			resources.rc
G3270_SRCS =			g3270.c iocallback.c topwindow.c terminal.c screen.c actions.c mouse.c \
						clipboard.c print.c config.c colors.c keypad.c plugin.c $(@host_os@-srcs)

windows-libsrcs = 		w3misc.c winvers.c windirs.c
linux-gnu-libsrcs =

LIBRARY_COMMOM_SRCS = 	XtGlue.c actions.c ansi.c apl.c charset.c ctlr.c \
						ft.c ft_cut.c ft_dft.c glue.c help.c host.c icmd.c idle.c kybd.c \
						macros.c print.c printer.c proxy.c resources.c rpq.c screen.c see.c \
						sf.c tables.c telnet.c toggles.c trace_ds.c utf8.c util.c \
						xio.c keymap.c resolver.c log.c $(@host_os@-libsrcs)

LIBRARY_SRCS = $(LIBRARY_COMMOM_SRCS)

# Main Targets
Debug: $(foreach BIN, $(TARGETS), bin/Debug/$(BIN)) $(foreach BIN, $(PLUGINS), bin/Debug/plugins/$(BIN).@DLLEXT@) src/g3270/$(PACKAGE).jpg

Release: $(foreach BIN, $(TARGETS), bin/Release/$(BIN)) src/g3270/$(PACKAGE).jpg $(foreach BIN, $(PLUGINS), bin/Release/plugins/$(BIN).@DLLEXT@)

# Rules
GLOBAL_DEPENDS=src/include/*.h src/include/lib3270/*.h Makefile

# Debug Rules
obj/Debug/src/lib/%.o: src/lib/%.c src/lib/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 -DLIB3270=1 $(CFLAGS) @LIBSSL_CFLAGS@ -Isrc/lib -Isrc/include/lib3270 -ggdb -o $@ -c $<

obj/Debug/src/g3270/%.o: src/g3270/%.c src/g3270/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 $(CFLAGS) @GTK_CFLAGS@ @LIBGNOME_CFLAGS@ @PROGRAM_FLAGS@ -Isrc/lib -ggdb -o $@ -c $<

obj/Debug/src/g3270/resources.o: src/g3270/resources.rc src/g3270/$(PACKAGE).ico Makefile
	@echo $< ...
	@$(WINDRES) --include-dir=src/g3270 -i $< -o $@

obj/Debug/version.o: src/version.c
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DDEBUG=1 $(CFLAGS) -Isrc/lib -ggdb -o $@ -c $<

# Release rules
obj/Release/src/lib/%.o: src/lib/%.c src/lib/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) -DLIB3270=1 $(CFLAGS) -Werror @LIBSSL_CFLAGS@ -Isrc/lib -Isrc/include/lib3270 -ggdb -o $@ -c $<

obj/Release/src/g3270/%.o: src/g3270/%.c src/g3270/*.h $(GLOBAL_DEPENDS)
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) $(CFLAGS) @GTK_CFLAGS@ @LIBGNOME_CFLAGS@ @PROGRAM_FLAGS@ -Isrc/lib -o $@ -c $<

obj/Release/src/g3270/resources.o: src/g3270/resources.rc src/g3270/$(PACKAGE).ico Makefile
	@echo $< ...
	@$(WINDRES) --include-dir=src/g3270 -i $< -o $@

obj/Release/version.o: src/version.c
	@echo $< ...
	@mkdir -p `dirname $@`
	@$(CC) $(CFLAGS) -Werror -Isrc/lib -o $@ -c $<

obj/Release/src/lib/w3n46.o: src/lib/resolver.c
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) $(CFLAGS) -Werror -Isrc/lib -DW3N46 -c -o $@ $^

# Release Targets
bin/Release/@PACKAGE_NAME@@BINEXT@: bin/Release/lib3270.@DLLEXT@ $(foreach SRC, $(basename $(G3270_SRCS)), obj/Release/src/g3270/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) $(@host_os@-exeopt) -o $@ $^ @GTK_LIBS@ @LIBGNOME_LIBS@ @PROGRAM_LIBS@ @OS_LIBS@

bin/Release/lib3270.@DLLEXT@: obj/Release/version.o obj/Release/src/lib/fallbacks.o $(foreach SRC, $(basename $(LIBRARY_SRCS)), obj/Release/src/lib/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) $(DLLFLAGS) -Wl,-soname,$(@F) -o $@ $^ @LIBSSL_LIBS@ @OS_LIBS@

bin/Release/w3n46.dll: obj/Release/src/lib/w3n46.o
	@$(CC) $(DLLFLAGS) -o $@ $^ @OS_LIBS@

# Debug Targets
bin/Debug/@PACKAGE_NAME@@BINEXT@: bin/Debug/lib3270.@DLLEXT@ $(foreach SRC, $(basename $(G3270_SRCS)), obj/Debug/src/g3270/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) $(@host_os@-exeopt) -o $@ $^ @GTK_LIBS@ @LIBGNOME_LIBS@ @PROGRAM_LIBS@ @OS_LIBS@

bin/Debug/lib3270.@DLLEXT@: obj/Debug/version.o obj/Release/src/lib/fallbacks.o $(foreach SRC, $(basename $(LIBRARY_SRCS)), obj/Debug/src/lib/$(SRC).@OBJEXT@)
	@echo $@ ...
	@mkdir -p `dirname $@`
	@$(CC) $(DLLFLAGS) -Wl,-soname,$(@F) -o $@ $^ @LIBSSL_LIBS@ @OS_LIBS@

bin/Debug/w3n46.dll: obj/Release/src/lib/w3n46.o
	@$(CC) $(DLLFLAGS) -o $@ $^ @OS_LIBS@

src/g3270/$(PACKAGE).ico: @ICONFILE@
	@cp @ICONFILE@ $@

src/g3270/$(PACKAGE).jpg: @LOGOFILE@
	@cp @LOGOFILE@ $@

# Plugins
bin/Release/plugins/rx3270.@DLLEXT@: obj/Release/src/plugins/rexx/*.o
	@make -C src/plugins/rexx ../../../bin/Release/plugins/`basename $@`

obj/Release/src/plugins/rexx/%.o: src/plugins/rexx/%.c src/plugins/rexx/Makefile $(GLOBAL_DEPENDS)
	@make -C src/plugins/rexx ../../../obj/Release/src/plugins/rexx/`basename $@`

bin/Debug/plugins/rx3270.@DLLEXT@: obj/Debug/src/plugins/rexx/*.o
	@make -C src/plugins/rexx ../../../bin/Debug/plugins/`basename $@`

obj/Debug/src/plugins/rexx/%.o: src/plugins/rexx/%.c src/plugins/rexx/Makefile $(GLOBAL_DEPENDS)
	@make -C src/plugins/rexx ../../../obj/Debug/src/plugins/rexx/`basename $@`

# Other targets
src/lib/fallbacks.c:  src/lib/X3270.xad
	@make -C src/lib fallbacks.c

src/version.c:	src/lib/*.c src/mkversion.sh Makefile $(GLOBAL_DEPENDS)
	@src/mkversion.sh

sources.lst: Makefile src/g3270/*.c src/plugins/rexx/*.c Makefile
	@rm -f $@
	@for i in src/g3270/*.c; do echo $$i >> $@; done
	@for i in src/plugins/rexx/*.c; do echo $$i >> $@; done

$(PACKAGE).pot: sources.lst
	@xgettext	--files-from=sources.lst \
			--default-domain=$(PACKAGE) --language=C \
			--keyword=_ --keyword=N_ --sort-output --output=- \
	| sed "s&PACKAGE VERSION&$(PACKAGE) $(PACKAGE_VERSION)&;s&CHARSET&UTF-8&" > $@

$(PACKAGE).po: $(PACKAGE).pot
	@msginit --no-translator -o $(PACKAGE).po -i $(PACKAGE).pot

run: bin/Debug/g3270@BINEXT@ $(foreach BIN, $(PLUGINS), bin/Debug/plugins/$(BIN).@DLLEXT@) src/g3270/$(PACKAGE).jpg
	@msgfmt -c -v -o $(LOCALEDIR)/pt_BR/LC_MESSAGES/g3270.mo po/pt_BR.po
	@cd bin/Debug ; LD_LIBRARY_PATH=. ./g3270

tgz: $(PACKAGE)-$(PACKAGE_VERSION).tar.gz

install: Release po/pt_BR.po
	@mkdir -p $(DESTDIR)/$(bindir)
	@mkdir -p $(DESTDIR)/$(LIBDIR)/$(PACKAGE)/plugins
	@mkdir -p $(DESTDIR)/$(datarootdir)/$(PACKAGE)/ui
	@mkdir -p $(DESTDIR)/$(LOCALEDIR)
	@mkdir -p $(DESTDIR)/@includedir@/lib3270
	@for i in $(TARGETS); do install --mode=755 bin/Release/$$i $(DESTDIR)/$(bindir); done
	@for i in $(PLUGINS); do install --mode=755 bin/Release/plugins/$$i.@DLLEXT@ $(DESTDIR)/$(LIBDIR)/$(PACKAGE)/plugins; done
	@install --mode=755 bin/Release/lib3270.so $(DESTDIR)/$(LIBDIR)
	@install --mode=644 src/g3270/actions.conf $(DESTDIR)/$(datarootdir)/$(PACKAGE)
	@install --mode=644 ui/g3270.xml $(DESTDIR)/$(datarootdir)/$(PACKAGE)/ui
	@install --mode=644 src/g3270/$(PACKAGE).jpg $(DESTDIR)/$(datarootdir)/$(PACKAGE)
	@install --mode=644 src/include/lib3270/*.h $(DESTDIR)/@includedir@/lib3270

	@mkdir -p $(DESTDIR)/$(LOCALEDIR)/pt_BR/LC_MESSAGES
	@msgfmt -c -v -o $(DESTDIR)/$(LOCALEDIR)/pt_BR/LC_MESSAGES/g3270.mo po/pt_BR.po

$(PACKAGE)-$(PACKAGE_VERSION).tar.gz: clean

	@rm -fr $(TMPDIR)/$(PACKAGE).tmp

	@mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp g3270.cbp $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp aclocal.m4 $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp AUTHORS $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp configure.ac $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp g3270.nsi.in $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp g3270.pc.in $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp g3270.spec.in $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)
	@cp Makefile.in $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)

	mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/image
	cp -r image/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/image

	mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/ui
	cp -r ui/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/ui

	@mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/po
	@cp -r po/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/po

	@mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/src
	@cp -r src/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/src

	@mkdir -p $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/scripts
	@cp -r scripts/* $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/scripts

	@rm -f $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/Makefile
	@rm -f $(TMPDIR)/$(PACKAGE).tmp/$(PACKAGE)-$(PACKAGE_VERSION)/*.layout
	@tar --create --gzip --verbose --directory $(TMPDIR)/$(PACKAGE).tmp --exclude=.svn --file=$@ $(PACKAGE)-$(PACKAGE_VERSION)
	@echo $@

clean:
	@rm -fr obj
	@rm -fr bin
	@rm -f	src/lib/fallbacks.c
	@rm -f	src/lib/version.o
	@rm -f	src/lib/mkfb.exe
	@rm -f	src/version.c
	@rm -f	sources.lst
	@rm -f	$(PACKAGE)-$(PACKAGE_VERSION).tar.gz
	@rm -f $(PACKAGE).pot
	@rm -f $(PACKAGE).po
	@rm -f src/g3270/resources.rc
	@rm -fr autom4te.cache
	@rm -f config.status
	@rm -f *.lnk
	@rm -fr locale
	@rm -f *.nsi
	@rm -f src/g3270/$(PACKAGE).ico
	@rm -f src/g3270/$(PACKAGE).jpg
	@make -C src/plugins/rexx clean
	@find . -name "*.save" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*~" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.bak" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.log" -exec mv -f {} $(TMPDIR) \;
	@find . -name "leak.out" -exec mv -f {} $(TMPDIR) \;
	@find . -name "*.tmp" -exec mv -f {} $(TMPDIR) \;
